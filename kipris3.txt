# -*- coding: utf-8 -*-
"""
KIPRIS â–¸ [ìƒì„¸ê²€ìƒ‰] â–¸ ì¸ëª…ì •ë³´ â–¸ ìµœì¢…ê¶Œë¦¬ì(TRH)
ê³ ê°ë²ˆí˜¸ë¡œ ê²€ìƒ‰ â†’ ê²°ê³¼(searchResult.do)ì—ì„œ 'ì¶œì›ë²ˆí˜¸(ì¼ì)'ë§Œ ìˆ˜ì§‘

ì„¤ì¹˜:
    pip install playwright
    playwright install

ì‹¤í–‰:
    python kipris_final_owner_appnos.py --customer 120230740981
    # ì˜µì…˜ ì—†ì´ ì‹¤í–‰í•˜ë©´ í”„ë¡¬í”„íŠ¸ë¡œ ê³ ê°ë²ˆí˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.

ì˜µì…˜:
    --headful         : ë¸Œë¼ìš°ì € ì°½ ë„ì›Œì„œ ì‹¤í–‰
    --max-pages N     : ìµœëŒ€ í˜ì´ì§€ ìˆ˜ (ê¸°ë³¸ 100)
    --timeout MS      : ë‹¨ê³„ë³„ íƒ€ì„ì•„ì›ƒ(ms, ê¸°ë³¸ 20000)
"""
import asyncio
import re
import sys
import argparse
from typing import List, Set
from playwright.async_api import async_playwright, Page, TimeoutError as PWTimeoutError

KIPRIS_HOME = "https://www.kipris.or.kr/khome/main.do"
RESULT_URL_RE = re.compile(r"/khome/search/searchResult\.do", re.I)
APPNO_13 = re.compile(r"\b(1|2)\d{12}\b")  # êµ­ë‚´ ì¶œì›ë²ˆí˜¸(13ìë¦¬, 10/20 ì‹œì‘)

# ---------------- ìœ í‹¸ ----------------
async def try_click_many(page: Page, selectors: List[str], timeout: int = 2000) -> bool:
    for sel in selectors:
        try:
            loc = page.locator(sel).first
            if await loc.count():
                try: await loc.scroll_into_view_if_needed()
                except: pass
                try:
                    await loc.click(timeout=timeout)
                    return True
                except:
                    try:
                        ok = await page.evaluate(
                            """(selector) => {
                                const el = document.querySelector(selector);
                                if (!el) return false;
                                el.scrollIntoView({block:'center', inline:'center'});
                                el.click();
                                return true;
                            }""",
                            sel,
                        )
                        if ok: return True
                    except:
                        pass
        except:
            pass
    return False

def prompt_customer() -> str:
    print("\nê¶Œë¦¬ì ê³ ê°ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 120230740981): ", end="", flush=True)
    try:
        return input().strip()
    except EOFError:
        return ""

# ---------------- ë‹¨ê³„ ----------------
async def open_detail_search(page: Page, timeout: int):
    print("[1/6] ë©”ì¸ ì ‘ì†â€¦", flush=True)
    await page.goto(KIPRIS_HOME, wait_until="domcontentloaded", timeout=timeout)

    # íŒì—…/ë°°ë„ˆ ë‹«ê¸°
    for sel in ['button:has-text("ë‹«ê¸°")', 'button.close', '[aria-label="Close"]']:
        try:
            if await page.locator(sel).count():
                await page.locator(sel).first.click(timeout=800)
        except: pass

    print("[2/6] [ìƒì„¸ê²€ìƒ‰] ì§„ì… ì‹œë„â€¦", flush=True)
    clicked = await try_click_many(page, [
        "a:has-text('ìƒì„¸ê²€ìƒ‰')", "button:has-text('ìƒì„¸ê²€ìƒ‰')",
        "//a[contains(text(),'ìƒì„¸ê²€ìƒ‰')]", "//button[contains(text(),'ìƒì„¸ê²€ìƒ‰')]",
        "text=ìƒì„¸ê²€ìƒ‰",
    ], timeout=timeout)
    if not clicked:
        print("  - ìƒì„¸ê²€ìƒ‰ ë²„íŠ¼ íƒìƒ‰ ì‹¤íŒ¨(ìƒì„¸ì˜ì—­ì´ ê¸°ë³¸ ë…¸ì¶œ ë ˆì´ì•„ì›ƒì¼ ìˆ˜ ìˆìŒ).", flush=True)

    try:
        await page.wait_for_load_state("networkidle", timeout=timeout)
    except PWTimeoutError:
        pass

async def prepare_TRH_and_input(page: Page, timeout: int):
    print("[3/6] ì¸ëª…ì •ë³´ â–¸ ìµœì¢…ê¶Œë¦¬ì(TRH) ì„¤ì •â€¦", flush=True)
    await try_click_many(page, [
        "button:has-text('ì¸ëª…ì •ë³´')", "a:has-text('ì¸ëª…ì •ë³´')",
        "//button[contains(text(),'ì¸ëª…ì •ë³´')]", "//a[contains(text(),'ì¸ëª…ì •ë³´')]",
    ], timeout=timeout)
    try: await page.wait_for_timeout(300)
    except: pass

    # select#sd01_g04_category_07 => value='TRH', input í›„ë³´ ë°˜í™˜
    info = await page.evaluate("""
    () => {
      let sel = document.querySelector('#sd01_g04_category_07');
      if (!sel) {
        sel = Array.from(document.querySelectorAll('select')).find(s =>
          Array.from(s.options||[]).some(o => (o.value||'')==='TRH' || /ìµœì¢…ê¶Œë¦¬ì/.test(o.textContent||''))
        ) || null;
      }
      if (sel) {
        const prefer = Array.from(sel.options||[]).find(o => (o.value||'')==='TRH');
        if (prefer) sel.value = 'TRH';
        else {
          const byText = Array.from(sel.options||[]).find(o => /ìµœì¢…ê¶Œë¦¬ì/.test(o.textContent||''));
          if (byText) sel.value = byText.value;
        }
        sel.dispatchEvent(new Event('input', {bubbles:true}));
        sel.dispatchEvent(new Event('change', {bubbles:true}));
        try { sel.scrollIntoView({block:'center'}); } catch(e) {}
      }

      let inp = document.querySelector('input[data-field="TRH"]');
      if (!inp) inp = document.querySelector('#sd01_g04_text_07');
      if (!inp && sel) {
        const row = sel.closest('.row, tr, .search-row, .cell, .grid, .columns, .f-group') || sel.parentElement;
        if (row) inp = row.querySelector('input[type="text"]');
      }
      if (!inp) {
        inp = Array.from(document.querySelectorAll('input[type="text"]')).find(el => {
          const ph = (el.getAttribute('placeholder')||'') + ' ' + (el.getAttribute('aria-label')||'');
          return /ê³ ê°ë²ˆí˜¸|íŠ¹í—ˆê³ ê°ë²ˆí˜¸|TRH|ìµœì¢…ê¶Œë¦¬ì/.test(ph);
        }) || null;
      }
      if (!inp) return { ok:false };

      const selStr = sel ? (sel.id ? '#'+sel.id : 'select') : null;
      const inpStr = inp.id ? ('#'+inp.id) : (inp.getAttribute('data-field') ? `input[data-field="${inp.getAttribute('data-field')}"]` : 'input[type="text"]');
      try { inp.scrollIntoView({block:'center'}); } catch(e) {}
      return { ok:true, inputSelector: inpStr, selectSelector: selStr };
    }
    """)
    if not info or not info.get("ok"):
        raise RuntimeError("TRH ì…ë ¥ì¹¸ íƒìƒ‰ ì‹¤íŒ¨")

    return page.locator(info["inputSelector"])

async def submit_search(page: Page, trh_input, customer: str, timeout: int):
    print(f"[4/6] ê³ ê°ë²ˆí˜¸ ì…ë ¥: {customer}", flush=True)
    await trh_input.fill(customer, timeout=timeout)
    await page.evaluate("""(sel, val) => {
        const el = document.querySelector(sel);
        if (!el) return;
        el.value = val;
        el.dispatchEvent(new Event('input', {bubbles:true}));
        el.dispatchEvent(new Event('change', {bubbles:true}));
        el.dispatchEvent(new Event('blur', {bubbles:true}));
    }""", await trh_input.evaluate("el => el.id ? '#'+el.id : (el.getAttribute('data-field') ? `input[data-field=\"${el.getAttribute('data-field')}\"]` : 'input[type=\"text\"]')"), customer)

    print("[5/6] ê²€ìƒ‰ ì‹¤í–‰â€¦", flush=True)
    clicked = await try_click_many(page, [
        "button:has-text('ê²€ìƒ‰'):not(:has-text('ìƒì„¸'))",
        "button.btn-search", "input[type='submit'][value*='ê²€ìƒ‰']",
        "a:has-text('ê²€ìƒ‰'):not(:has-text('ìƒì„¸'))", "#searchBtn", ".search-btn",
    ], timeout=timeout)

    if not clicked:
        try:
            await page.evaluate("""() => {
                if (window.fnSearchDetail && typeof fnSearchDetail.search === 'function') {
                    fnSearchDetail.search();
                }
            }""")
        except: pass

    # í¼ ì§ì ‘ submit (action*='searchResult.do')
    await page.evaluate("""
    () => {
      const forms = Array.from(document.querySelectorAll('form'));
      const tgt = forms.find(f => (f.getAttribute('action')||'').includes('searchResult.do'));
      if (tgt) { try { tgt.submit(); } catch(e) {} }
    }
    """)
    # ë§ˆì§€ë§‰ Enter
    try: await trh_input.press("Enter")
    except: pass

    # ê²°ê³¼ ëŒ€ê¸°
    try:
        await page.wait_for_url(RESULT_URL_RE, timeout=timeout)
    except PWTimeoutError:
        try: await page.wait_for_load_state("networkidle", timeout=timeout)
        except PWTimeoutError: pass

# ğŸ”§ ì •ë°€ DOM ì„ íƒìœ¼ë¡œ ì¶œì›ë²ˆí˜¸ë§Œ ì¶”ì¶œ (ê´„í˜¸ ì• 13ìë¦¬)
async def extract_appnos_on_page(page: Page) -> List[str]:
    # 1) em.tit[data-lang-id="srlt.patent.an"]ê°€ ìˆëŠ” liì—ì„œ p.txt í…ìŠ¤íŠ¸ë§Œ ì·¨ë“
    appnos = await page.evaluate("""
    () => {
      const out = [];
      const labels = document.querySelectorAll('em.tit[data-lang-id="srlt.patent.an"]');
      labels.forEach(em => {
        const li = em.closest('li');
        if (!li) return;
        const p = li.querySelector('div.link-wrap > p.txt');
        if (!p) return;
        const txt = (p.textContent || '').replace(/\\s+/g, '');
        const m = txt.match(/(\\d{13})\\(/); // ê´„í˜¸ ì• 13ìë¦¬
        if (m) out.push(m[1]);
      });
      return out;
    }
    """)

    # 2) ë³´ì¡°: íƒ€ì´í‹€ ë²„íŠ¼ì˜ openDetail('kpat','1020160042595',...)ì—ì„œ ì¶”ì¶œ
    if not appnos or len(appnos) == 0:
        fallback = await page.evaluate("""
        () => {
          return Array.from(document.querySelectorAll('h1.title button[onclick^="openDetail"]'))
            .map(b => (b.getAttribute('onclick')||'').match(/'kpat'\\s*,\\s*'(\\d{13})'/))
            .filter(Boolean).map(m => m[1]);
        }
        """)
        appnos = fallback

    # ì •ë¦¬
    uniq = sorted(set([a for a in appnos if a and (/(1|2)\\d{12}/).test(a)]))
    return uniq

async def paginate(page: Page, timeout: int) -> bool:
    if await try_click_many(page, [
        "a:has-text('ë‹¤ìŒ')", "button:has-text('ë‹¤ìŒ')",
        "a:has-text('Next')", "button:has-text('Next')",
        "a:has-text('ï¼')", "a:has-text('>')",
        "button:has-text('ï¼')", "button:has-text('>')",
    ], timeout=timeout):
        try: await page.wait_for_load_state("networkidle", timeout=timeout)
        except PWTimeoutError: pass
        return True
    # ìˆ«ì í˜ì´ì§€
    try:
        cur = page.locator('[aria-current="page"]')
        if await cur.count():
            nxt = cur.locator('xpath=following::a[1]')
            if await nxt.count():
                await nxt.first.click(timeout=timeout)
                try: await page.wait_for_load_state("networkidle", timeout=timeout)
                except PWTimeoutError: pass
                return True
    except: pass
    return False

# ---------------- ë©”ì¸ ----------------
async def _main():
    parser = argparse.ArgumentParser(description="KIPRIS ìƒì„¸ê²€ìƒ‰ â–¸ ì¸ëª…ì •ë³´ â–¸ ìµœì¢…ê¶Œë¦¬ì(TRH) â–¸ 'ì¶œì›ë²ˆí˜¸(ì¼ì)' ìˆ˜ì§‘")
    parser.add_argument("--customer", "-c", type=str, default="", help="ê¶Œë¦¬ì ê³ ê°ë²ˆí˜¸(ë³´í†µ 12ìë¦¬)")
    parser.add_argument("--headful", action="store_true", help="ë¸Œë¼ìš°ì € ì°½ í‘œì‹œ(ë””ë²„ê¹…)")
    parser.add_argument("--max-pages", type=int, default=100, help="ìµœëŒ€ í˜ì´ì§€ ìˆ˜")
    parser.add_argument("--timeout", type=int, default=20000, help="íƒ€ì„ì•„ì›ƒ(ms)")
    args = parser.parse_args()

    customer = (args.customer or "").strip() or prompt_customer()
    if not customer:
        print("ê³ ê°ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.", flush=True); sys.exit(1)
    if customer.isdigit() and len(customer) < 12:
        customer = customer.zfill(12)
    print(f"[ê³ ê°ë²ˆí˜¸ í™•ì¸] {customer}", flush=True)

    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=not args.headful)
        page = await browser.new_page()
        try:
            await open_detail_search(page, timeout=args.timeout)
            trh_input = await prepare_TRH_and_input(page, timeout=args.timeout)
            await submit_search(page, trh_input, customer, timeout=args.timeout)

            print("[6/6] ê²°ê³¼ ìˆ˜ì§‘â€¦", flush=True)
            all_appnos: Set[str] = set()
            for _ in range(max(1, args.max_pages)):
                for a in await extract_appnos_on_page(page):
                    all_appnos.add(a)
                if not await paginate(page, timeout=args.timeout):
                    break
        finally:
            await browser.close()

    print("\n=== ì¶œì›ë²ˆí˜¸(ì¼ì) â€” Application Numbers ===", flush=True)
    lst = sorted(all_appnos)
    print(f"ì´ {len(lst)}ê±´", flush=True)
    for a in lst:
        print(a, flush=True)

if __name__ == "__main__":
    try:
        asyncio.run(_main())
    except KeyboardInterrupt:
        print("ì¤‘ë‹¨ë¨", flush=True)
