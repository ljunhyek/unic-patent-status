 1ë‹¨ê³„: ì´ˆê¸° ê²€ì¦ ë° ëª¨ë‹¬ í‘œì‹œ

  1. calculateAnnuityFees() í•¨ìˆ˜ ì‹¤í–‰
  2. window.currentPatents ë°°ì—´ì— íŠ¹í—ˆ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
  3. ê°ë©´ìœ í˜• ì„ íƒ ëª¨ë‹¬ (showDiscountSelectionModal()) í‘œì‹œ
  4. ì‚¬ìš©ìê°€ ê°ë©´ìœ í˜• ì„ íƒ í›„ "ê³„ì‚°í•˜ê¸°" ë²„íŠ¼ í´ë¦­

  2ë‹¨ê³„: ê° íŠ¹í—ˆë³„ ê³„ì‚° ë¡œì§ ì‹¤í–‰

  performNewAnnuityCalculation() í•¨ìˆ˜ê°€ ëª¨ë“  íŠ¹í—ˆë¥¼ ìˆœí™˜í•˜ë©° ê³„ì‚°

  2-1. ê¸°ë³¸ ë‚ ì§œ ì„¤ì •

  const today = new Date();  // í˜„ì¬ ë‚ ì§œ
  const registrationDate = new Date(patent.registrationDate);  // ë“±ë¡ì¼

  2-2. 3ë…„ ì—…í”„ë¡ íŠ¸ ê·œì¹™ ì ìš©

  const threeYearsAfterRegistration = new Date(registrationDate);
  threeYearsAfterRegistration.setFullYear(threeYearsAfterRegistration.getFullYear() + 3);
  - í•œêµ­ íŠ¹í—ˆë²•: ë“±ë¡ì¼ë¶€í„° 3ë…„ê°„ì€ ì—°ì°¨ë£Œ ì„ ë‚© (ì—…í”„ë¡ íŠ¸ ë‚©ë¶€)
  - 4ë…„ì°¨ë¶€í„° ì—°ì°¨ë£Œ ë‚©ë¶€ ì‹œì‘

  2-3. ì‹œë‚˜ë¦¬ì˜¤ ë¶„ê¸°

  ğŸ”¹ ì‹œë‚˜ë¦¬ì˜¤ A: í˜„ì¬ë‚ ì§œ < ë“±ë¡ì¼+3ë…„ (ì²« ì—°ì°¨ë£Œ ë‚©ë¶€ ì „)
  if (today < threeYearsAfterRegistration) {
      // ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”: '' (ë¹ˆì¹¸)
      // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼: ë“±ë¡ì¼ + 3ë…„
      // í•´ë‹¹ì—°ì°¨ìˆ˜: '4ë…„ì°¨'
      // ìœ íš¨/ë¶ˆë‚©: 'ìœ íš¨'
      // ì •ìƒë‚©ë¶€/ë¯¸ë‚©: 'ì •ìƒë‚©ë¶€'
  }

  ğŸ”¹ ì‹œë‚˜ë¦¬ì˜¤ B: í˜„ì¬ë‚ ì§œ â‰¥ ë“±ë¡ì¼+3ë…„ (ì—°ì°¨ë£Œ ë‚©ë¶€ ëŒ€ìƒ)

  3ë‹¨ê³„: ì—°ì°¨ìˆ˜ ê³„ì‚°

  // í˜„ì¬ ì—°ì°¨ìˆ˜ = 4ë…„ì°¨ë¶€í„° ì‹œì‘
  const annualYear = Math.floor((today.getTime() - threeYearsAfterRegistration.getTime()) / (365.25 * 24 * 60 * 60 *
   1000)) + 4;

  // ë‹¤ìŒ ì—°ì°¨ìˆ˜ (1ë…„ ì•ì„œì„œ ë‚©ë¶€í•˜ëŠ” ê°œë…)
  const nextYear = annualYear + 1;

  4ë‹¨ê³„: ê° ì»¬ëŸ¼ë³„ ê°’ ê³„ì‚°

  ğŸ“… ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”

  const previousYearDate = new Date(adjustedDueDate);
  previousYearDate.setFullYear(previousYearDate.getFullYear() - 1);
  // í˜•íƒœ: "2024-03" (ë…„-ì›” í˜•ì‹)

  ğŸ“… í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼

  const adjustedDueDate = new Date(registrationDate);
  adjustedDueDate.setFullYear(registrationDate.getFullYear() + 3);
  // í˜•íƒœ: "2024-03-15" (ë“±ë¡ì¼ + 3ë…„)

  ğŸ”¢ í•´ë‹¹ì—°ì°¨ìˆ˜

  const annualYear = nextYear + 'ë…„ì°¨';  // ì˜ˆ: "5ë…„ì°¨"

  ğŸ’° í•´ë‹¹ì—°ì°¨ë£Œ ê³„ì‚° - calculateNewAnnuityFee() í•¨ìˆ˜

  Step 1: ê¸°ë³¸ë£Œ í™•ì¸
  const NEW_BASE_FEES = {
      1: 13000,   2: 13000,   3: 13000,      // 1~3ë…„ì°¨: 13,000ì›
      4: 36000,   5: 36000,   6: 36000,      // 4~6ë…„ì°¨: 36,000ì›
      7: 90000,   8: 90000,   9: 90000,      // 7~9ë…„ì°¨: 90,000ì›
      10: 216000, 11: 216000, 12: 216000,    // 10~12ë…„ì°¨: 216,000ì›
      13: 324000, // ... 25ë…„ì°¨ê¹Œì§€ 324,000ì›
  };
  const baseFee = NEW_BASE_FEES[annualYear];

  Step 2: ì²­êµ¬í•­ ê°€ì‚°ë£Œ ê³„ì‚°
  const NEW_CLAIM_FEES = {
      1: 12000,   2: 12000,   3: 12000,      // 1~3ë…„ì°¨: 12,000ì›
      4: 20000,   5: 20000,   6: 20000,      // 4~6ë…„ì°¨: 20,000ì›
      7: 34000,   8: 34000,   9: 34000,      // 7~9ë…„ì°¨: 34,000ì›
      10: 49000,  11: 49000,  12: 49000,     // 10~12ë…„ì°¨: 49,000ì›
      13: 49000, // ... 25ë…„ì°¨ê¹Œì§€ 49,000ì›
  };
  const claimSurchargeFee = NEW_CLAIM_FEES[annualYear] * claimCount;

  Step 3: ì •ìƒ ì—°ì°¨ë£Œ ê³„ì‚°
  const normalFee = baseFee + claimSurchargeFee;

  Step 4: ê°ë©´ìœ¨ ì ìš©
  const NEW_DISCOUNT_TYPES = {
      'type1': { rate: 0.5, applicableFromYear: 4 },           // 50% ê°ë©´
      'type1_1': { rate: 0.7, rate10Plus: 0.5, applicableFromYear: 4 }, // 4~9ë…„ì°¨ 70%, 10ë…„ì°¨+ 50%
      'type2': { rate: 0.3, applicableFromYear: 4, applicableToYear: 9 }, // 4~9ë…„ì°¨ 30%
      'type2_1': { rate: 0.5, applicableFromYear: 4, applicableToYear: 9 }, // 4~9ë…„ì°¨ 50%
      'none': { rate: 0 }                                     // ê°ë©´ ì—†ìŒ
  };

  const discountedFee = Math.round(normalFee * (1 - discountRate));

  âš–ï¸ ìœ íš¨/ë¶ˆë‚© ìƒíƒœ ê³„ì‚° - computeStatus() í•¨ìˆ˜

  function computeStatus(dueDate, today, policy) {
      const graceEnd = endOfMonthSafeAddMonths(dueDate, 6);      // ì¶”ë‚©ê¸°ê°„ 6ê°œì›”
      const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, 3);  // íšŒë³µê¸°ê°„ 3ê°œì›”

      if (today <= dueDate) return "ìœ íš¨";
      if (dueDate < today && today <= graceEnd) return "ì¶”ë‚©ê¸°ê°„";
      if (graceEnd < today && today <= recoveryEnd) return "íšŒë³µê¸°ê°„";
      return "ë¶ˆë‚©";
  }

  ğŸ’³ ì •ìƒë‚©ë¶€/ë¯¸ë‚© ìƒíƒœ

  let paymentStatus = "ì •ìƒë‚©ë¶€";
  if (currentStatus === "ë¶ˆë‚©") {
      paymentStatus = "ë¯¸ë‚©";
  } else if (currentStatus !== "ìœ íš¨") {
      paymentStatus = currentStatus; // "ì¶”ë‚©ê¸°ê°„", "íšŒë³µê¸°ê°„"
  }

  â° ì¶”ë‚©ê¸°ê°„ ê³„ì‚°

  const graceEnd = endOfMonthSafeAddMonths(dueDate, 6); // ë‚©ë¶€ë§ˆê°ì¼ + 6ê°œì›”

  if (status === "ìœ íš¨") {
      latePaymentPeriod = dueDate + ' ~ ' + graceEnd;  // "2024-03-15 ~ 2024-09-15"
  } else if (status === "ì¶”ë‚©ê¸°ê°„") {
      latePaymentPeriod = 'ì§„í–‰ì¤‘ (' + graceEnd + ' ë§ˆê°)';
  }

  ğŸ”„ íšŒë³µê¸°ê°„ ê³„ì‚°

  const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, 3); // ì¶”ë‚©ê¸°ê°„ ì¢…ë£Œ + 3ê°œì›”

  if (status === "ìœ íš¨" || status === "ì¶”ë‚©ê¸°ê°„") {
      recoveryPeriod = graceEnd + ' ~ ' + recoveryEnd;  // "2024-09-15 ~ 2024-12-15"
  } else if (status === "íšŒë³µê¸°ê°„") {
      recoveryPeriod = 'ì§„í–‰ì¤‘ (' + recoveryEnd + ' ë§ˆê°)';
  }

  5ë‹¨ê³„: ë°ì´í„° ì €ì¥ ë° UI ì—…ë°ì´íŠ¸

  // ê³„ì‚°ëœ ë°ì´í„°ë¥¼ íŠ¹í—ˆ ê°ì²´ì— ì €ì¥
  patent.calculatedData = {
      previousPaymentMonth: "2023-03",        // ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”
      dueDate: "2024-03-15",                  // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
      annualYear: "5ë…„ì°¨",                     // í•´ë‹¹ì—°ì°¨ìˆ˜
      annualFee: "72,000ì›",                   // í•´ë‹¹ì—°ì°¨ë£Œ
      validityStatus: "ìœ íš¨",                   // ìœ íš¨/ë¶ˆë‚©
      paymentStatus: "ì •ìƒë‚©ë¶€",                // ì •ìƒë‚©ë¶€/ë¯¸ë‚©
      latePaymentPeriod: "2024-03-15 ~ 2024-09-15", // ì¶”ë‚©ê¸°ê°„
      recoveryPeriod: "2024-09-15 ~ 2024-12-15"     // íšŒë³µê¸°ê°„
  };

  // í˜„ì¬ í˜ì´ì§€ í…Œì´ë¸” UI ì—…ë°ì´íŠ¸ (í•´ë‹¹ íŠ¹í—ˆê°€ í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ê²½ìš°)
  if (cells) {
      cells[9].textContent = patent.calculatedData.previousPaymentMonth;
      cells[10].textContent = patent.calculatedData.dueDate;
      cells[11].textContent = patent.calculatedData.annualYear;
      // ... ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ë“¤
  }

  6ë‹¨ê³„: ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ

  - ì„ íƒí•œ ê°ë©´ìœ í˜• ì •ë³´ì™€ í•¨ê»˜ ê³„ì‚° ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
  - 5ì´ˆ í›„ ìë™ ì œê±°

  ì´ë ‡ê²Œ ë³µì¡í•œ í•œêµ­ íŠ¹í—ˆë²•ì˜ 3ë…„ ì—…í”„ë¡ íŠ¸ ë‚©ë¶€ ê·œì •ê³¼ ë‹¤ì–‘í•œ ê°ë©´ ì •ì±…ì„ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ ì •í™•í•œ ì—°ì°¨ë£Œì™€ ê´€ë ¨ ì¼ì •ì„
  ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤! ğŸ¯